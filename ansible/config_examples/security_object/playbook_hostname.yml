- hosts: all
  connection: local
  gather_facts: False

  tasks:
    - name: "Change Panorama hostname and domain name via API"
      uri:
        url: "https://{{ panorama_ip }}/api/"
        method: POST
        body_format: form-urlencoded
        body: >
          type=config&action=set&key={{ lookup('env', 'pan_api_key') }}&
          xpath=/config/mgt-config/devices/entry[@name='localhost.localdomain']&
          element=<hostname>{{ new_hostname }}</hostname><domain>{{ new_domain_name }}</domain>
        validate_certs: no
      register: response

    - name: Commit changes on Panorama via API
      uri:
        url: "https://{{ panorama_ip }}/api/"
        method: POST
        body_format: form-urlencoded
        body: "type=commit&cmd=<commit></commit>&key={{ lookup('env', 'pan_api_key') }}"
        validate_certs: no
      register: commit_response

    - name: Push changes on Panorama via API
      uri:
        url: "https://{{ panorama_ip }}/api/"
        method: POST
        body_format: form-urlencoded
        body: "type=commit&action=all&cmd=<commit-all></commit-all>&key={{ lookup('env', 'pan_api_key') }}"
        validate_certs: no
      register: push_response
      
    - name: Debug API responses
      debug:
        var: item.content
      with_items:
        - "{{ response }}"
        - "{{ commit_response }}"
        - "{{ push_response }}"
    - name: Commit changes on Panorama via API
      uri:
       url: "https://{{ panorama_ip }}/api/"
       method: POST
       body_format: form-urlencoded
       body: "type=commit&cmd=<commit></commit>&key={{ lookup('env', 'pan_api_key') }}"
       validate_certs: no
      register: commit_response

    - name: Pause before pushing changes
      pause:
        seconds: 60  # Adjust the delay as needed

    - name: Push changes on Panorama via API
      uri:
       url: "https://{{ panorama_ip }}/api/"
       method: POST
       body_format: form-urlencoded
       body: "type=commit&action=all&cmd=<commit-all></commit-all>&key={{ lookup('env', 'pan_api_key') }}"
       validate_certs: no
      register: push_response
